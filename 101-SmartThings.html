<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<script type="text/x-red" data-template-name="device-profile">
    <div class="form-row">
        <label for="node-input-name">Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-capabilityId">Capability</label>
        <select type="text" id="node-input-capabilityId" style="width: 70%;"></select>
    </div>
</script>
<script type="text/x-red" data-help-name="device-profile">
    <p>This node represents an installed device. In this flow, You need to choose a device for automation.</p>
    <p>Event, Status and Command nodes need to know which devices will subscribe to the SmartThings Cloud or commands.</p>
    <p>This node has a capability that represents device feature. You can find more information about <a href="https://smartthings.developer.samsung.com/docs/api-ref/capabilities.html" target="_blank">the Capabilities of SmartThings</a>.</p>
    <h3>Properties</h3>
    <dl class="message-properties">
        <dt>Name<span class="property-type">required</span></dt>
        <dd>The label of the Name assigned by the user. It's unique name in flow.</dd>
        <dt>Capability<span class="property-type">required</span></dt>
        <dd>
            <ul>
                <li>The List of Capabilities provided by this Device.</li>
                <li>Determine if this Device supports the specified capability name.</li>
            </ul>
        </dd>
    </dl>
</script>
<script type="text/x-red" data-template-name="installed-device">
    <div class="form-tips" style="margin-bottom:10px;"><b>Note:</b> create token on the SmartThings <b><a href="https://account.smartthings.com/tokens" target="_blank">personal access token page</a></b></div>

    <div class="form-row">
        <label for="node-input-name">name</span></label>
        <input type="text" id="node-input-name" disabled>
    </div>
    <div class="form-row">
        <label for="node-input-name">label</label>
        <input type="text" id="node-input-label" disabled>
    </div>
    <div class="form-row">
        <label for="node-input-stAccessToken">Personal Access Token</label>
        <input type="text" id="node-input-stAccessToken">
    </div>
    <div id="my-device-list-div" class="form-row sensor-container-row">
        <ol id="my-device-list-container"></ol>
    </div>
</script>
<script type="text/x-red" data-help-name="installed-device">
    <p>This node represents an your SmartThings device. You can control your SmartThings devices directly without even registering the Automation.</p>
    <p>To do this, you should set your PAT on this node and select one on your device list. Then, you can get a condition or put a command to your installed devices by using 'Status', 'Command' nodes.</p>
    <p>After setting your PAT, get your device list and select device that you want to control.</p>
    <h3>Getting a SmartThings PAT</h3>
        <ul>
            <li>SmartThings Authentication : <a href="https://smartthings.developer.samsung.com/docs/api-ref/st-api.html#section/Authentication">API Reference, Authentication</a></li>
            <li>PATs can be created and managed on the <a href="https://account.smartthings.com/tokens">personal access token page</a>.</li>
        </ul>
    <h3>Properties</h3>
    <dl class="message-properties">
        <dt>Device Name<span class="property-type">read-only</span></dt>
        <dd>The label of the Name assigned by the user. It's unique name in flow.</dd>
        <dt>Device Label<span class="property-type">read-only</span></dt>
        <dd> </dd>
        <dt>Personal Access Token<span class="property-type">required</span></dt>
        <dd></dd>
        <dt>Device List</dt>
        <dd>
            <ul>
                <li>The List of your device that .</li>
                <li>Select device that you want to control, subscribe</li>
            </ul>
        </dd>
    </dl>
</script>
<script type="text/x-red" data-template-name="automation">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input id="node-input-name" type="text" placeholder="Name"/>
    </div>
    <div class="form-row">
        <label for="node-input-url"><i class="fa fa-cog"></i> Endpoint</label>
        <input id="node-input-url" type="text"  placeholder="/url"/>
    </div>
    <div class="form-row">
        <label for="node-input-copyurl"></label>
        <div style="display: inline-block; position: relative; width: 70%; height: 20.0114px;">
            <div style="position: absolute; left: 0px; right: 40px;">
                <input type="text" id="node-input-copyurl" readonly="true" style="width:100%"></input>
            </div>
            <a id="export-clipboard" class="editor-button" style="position: absolute; right: 0px; top: 0px;">
                <i class="fa fa-copy"></i>
            </a>
        </div>
    </div>
    <div class="form-row">
        <label for="node-input-publickey"><i class="fa fa-th"></i> Public Key</label>
        <textarea id="node-input-publickey" cols="60" rows="8"  style="margin: 0px; width: 354px; height: 174px;"></textarea>
    </div>
    <div class="form-tips"><b>Note:</b> How to get Public Key. See info box for details.</div>
</script>
<script type="text/x-red" data-help-name="automation">
    <p>This node represents the WebHook Endpoint of SmartApp. the Automation node handles lifecycle of SmartApp.</p>
    <p>A WebHook endpoint in this context is a web services application which can receive incoming HTTP POST requests.</p>
    <p></p>
    <p><a href="https://smartthings.developer.samsung.com/docs/guides/smartapps/webhook-apps.html" target="_blank">more...</a></p>
    <h3>Properties</h3>
    <dl class="message-properties">
        <dt>Name <span class="property-type">required</span></dt>
        <dd>A Name for the WebHook endpoint.</dd>
        <dt>Endpoint <span class="property-type">required</span></dt>
        <dd>A Endpoint that should be invoked during execution.</dd>
        <dt>Public Key <span class="property-type">required</span></dt>
        <dd>The public half of an RSA key pair. Useful for verifying a Webhook execution request signature to ensure it came from SmartThings.</dd>
    </dl>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>[lifecyle] Event</dt>
        <dd>Next node is the Event node only.</dd>
    </dl>
    <h3>Detail</h3>
    <p><b>How to get the Public Key</b></p>
    <p>When you create SmartApp on the SmartThing Cloud, you can get the Public Key. You can regist Automation on the SmartThings Developer Workspace.</p>
    <p><a href="https://smartthings.developer.samsung.com/docs/workspace/tutorials/create-an-automation.html#Register-the-Automation" target="_blank">more...</a></p>
</script>

<script type="text/x-red" data-template-name="event-device">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name" style="width:50%">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-cog"></i> Device</label>
        <select type="text"  id="node-input-deviceNodeId" style="width:50%"></select>
    </div>
    <hr align="middle" />
    <div class="form-row">
        <label for="node-input-capabilityId"><i class="fa fa-asterisk"></i> Capability</label>
        <select id="node-input-capabilityId" style="width:50%;"/>
    </div>
    <div class="form-row">
        <label for="node-input-capabilityId"><i class="fa fa-sun-o"></i>
            <span class="sensor-container-row"> Attribute</span>
        </label>
        <select style="width:50%" id="node-input-attributeId" class="form-row"/>
    </div>
    <div class="form-row sensor-container-row">
        <ol id="attr-list-container"></ol>
    </div>

</script>
<script type="text/x-red" data-help-name="event-device">
    <p>This node represents a change of device.</p>
    <p>When a user installs a SmartApp, they typically will select the devices to be used by the SmartApp.</p>
    <p>This event-device node interacts with installed SmartThings device. When the device changes and an event occurs, the event node can receive the event as a subscriber.</p>
    <h3>Properties</h3>
    <dl class="message-properties">
        <dt>Name <span class="property-type">required</span></dt>
        <dd>The label of the Device assigned by the user.</dd>
        <dt>Device </dt>
        <dd>The unique system identifier for this Device.</dd>
        <dt>Capability <span class="property-type">required</span></dt>
        <dd>
            <ul>
                <li>The List of Capabilities provided by this Device.</li>
                <li>Determine if this Device supports the specified capability name.</li>
            </ul>
        </dd>
        <dt>Attribute</dt>
        <dd>
            <ul>
                <li>The list of Attribute s for this Device.</li>
                <li>Determine if this Device has the specified attribute.</li>
            </ul>
        </dd>
     </dl>
</script>

<script type="text/x-red" data-template-name="status-device">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name" style="width:50%">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-cog"></i> Device</label>
        <select type="text"  id="node-input-deviceNodeId" style="width:50%"></select>
    </div>
    <hr align="middle" />
    <div class="form-row">
        <label for="node-input-capabilityId"><i class="fa fa-asterisk"></i> Capability</label>
        <select id="node-input-capabilityId" style="width:50%;"/>
    </div>
    <div class="form-row">
        <label for="node-input-capability"> <i class="fa fa-sun-o"></i>
            <span class="sensor-container-row"> Attribute</span>
        </label>
        <select style="width:50%" id="node-input-attributeId" class="form-row"/>
    </div>
    <div class="form-row sensor-container-row">
        <ol id="attr-list-container"></ol>
    </div>
</script>
<script type="text/x-red" data-help-name="status-device">
    <p>This node checks the state of the device.</p>
    <p>When a user installs a SmartApp, A user will select the devices to be used by the SmartApp.</p>
    <p>This status-device node interact with the installed SmartThings device. This node allows you to branch flows based on the state of the device.</p>
    <h3>Properties</h3>
    <dl class="message-properties">
        <dt>Name <span class="property-type">required</span></dt>
        <dd>The label of the Device assigned by the user.</dd>
        <dt>Device </dt>
        <dd>The unique system identifier for this Device.</dd>
        <dt>Capability <span class="property-type">required</span></dt>
        <dd>
            <ul>
                <li>The List of Capabilities provided by this Device.</li>
                <li>Determine if this Device supports the specified capability name.</li>
            </ul>
        </dd>
        <dt>Attribute</dt>
        <dd>
            <ul>
                <li>The list of Attribute s for this Device.</li>
                <li>Determine if this Device has the specified attribute.</li>
            </ul>
        </dd>
     </dl>
</script>

<script type="text/x-red" data-template-name="command-device">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name" style="width:50%">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-cog"></i> Device</label>
        <select type="text" id="node-input-deviceNodeId" style="width:50%"></select>
    </div>
    <hr align="middle" />
    <div class="form-row">
        <label for="node-input-capabilityId"><i class="fa fa-asterisk"></i> Capability</label>
        <select id="node-input-capabilityId" style="width:50%;"/>
    </div>
    <div class="form-row">
        <label for="node-input-capabilityId"> <i class="fa fa-sun-o"></i>
            <span class="actuator-container-row"> Command</span>
        </label>
        <select style="width:50%" id="node-input-attributeId" class="form-row"/>
    </div>
    <div class="form-row actuator-container-row">
        <ol id="cmd-list-container"></ol>
    </div>

</script>
<script type="text/x-red" data-help-name="command-device">
    <p>This node can command to the device.</p>
    <p>When a user installs a SmartApp, A user will select the devices to be used by the SmartApp.</p>
    <p>This command-device node interact with the installed SmartThings device. As commands you set, this node changes the state of the device.</p>
    <h3>Properties</h3>
    <dl class="message-properties">
        <dt>Name <span class="property-type">required</span></dt>
        <dd>The label of the Device assigned by the user.</dd>
        <dt>Device </dt>
        <dd>The unique system identifier for this Device.</dd>
        <dt>Capability <span class="property-type">required</span></dt>
        <dd>
            <ul>
                <li>The List of Capabilities provided by this Device.</li>
                <li>Determine if this Device supports the specified capability name.</li>
            </ul>
        </dd>
        <dt>Command</dt>
        <dd>
            <ul>
                <li>The list of Commands for this Device.</li>
                <li>Determine if this Device has the specified command name.</li>
            </ul>
        </dd>
     </dl>
</script>
<!-- Node Html End-->

<script type="text/javascript">
    // https://api.smartthings.com/v1/devices
    SmartThingsApi = {
        getDeviceList: function (token, done, fail) {
            $.ajax({
                url: "https://api.smartthings.com/v1/devices",
                headers: {
                    Authorization: 'Bearer ' + token
                }
            }).done(function (devices, textStatus, xhr) {
                done(devices.items);
            }).fail(function (e) {
                fail(e);
            });
        }
    };
</script>
<!-- Node Common Script-->
<script type="text/javascript">
    function Profiles() {
        var liveCapabilities;
        /*
        * capability ver.2020.03.30
        * https://smartthings.developer.samsung.com/docs/api-ref/capabilities.html
        */
        var _raw_capabilities = [{"id":"accelerationSensor","version":1,"name":"Acceleration Sensor","status":"live","attributes":{"acceleration":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"ActivityState","type":"string","enum":["active","inactive"]}},"required":["value"]}}},"commands":{}},{"id":"activityLightingMode","version":1,"name":"Activity Lighting Mode","status":"proposed","attributes":{"lightingMode":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"string","enum":["reading","writing","computer","night"]}},"required":["value"]}}},"commands":{"setLightingMode":{"arguments":[{"name":"lightingMode","schema":{"type":"string","enum":["reading","writing","computer","night"]},"required":true}]}}},{"id":"airConditionerMode","version":1,"name":"Air Conditioner Mode","status":"proposed","attributes":{"airConditionerMode":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"HvacMode","type":"string","enum":["auto","cool","dry","coolClean","dryClean","fanOnly","heat","heatClean","notSupported"]}},"required":["value"]}}},"commands":{"setAirConditionerMode":{"arguments":[{"name":"mode","schema":{"title":"HvacMode","type":"string","enum":["auto","cool","dry","coolClean","dryClean","fanOnly","heat","heatClean","notSupported"]},"required":true}]}}},{"id":"airQualitySensor","version":1,"name":"Air Quality Sensor","status":"live","attributes":{"airQuality":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"integer","minimum":0,"maximum":100},"unit":{"type":"string","enum":["CAQI"],"default":"CAQI"}},"required":["value"]}}},"commands":{}},{"id":"alarm","version":1,"name":"Alarm","status":"live","attributes":{"alarm":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"AlertState","type":"string","enum":["both","off","siren","strobe"]}},"required":["value"]}}},"commands":{"both":{"arguments":[]},"off":{"arguments":[]},"siren":{"arguments":[]},"strobe":{"arguments":[]}}},{"id":"audioMute","version":1,"name":"Audio Mute","status":"live","attributes":{"mute":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"MuteState","type":"string","enum":["muted","unmuted"]}},"required":["value"]}}},"commands":{"setMute":{"arguments":[{"name":"state","schema":{"title":"MuteState","type":"string","enum":["muted","unmuted"]},"required":true}]},"mute":{"arguments":[]},"unmute":{"arguments":[]}}},{"id":"audioVolume","version":1,"name":"Audio Volume","status":"proposed","attributes":{"volume":{"schema":{"title":"IntegerPercent","type":"object","additionalProperties":false,"properties":{"value":{"type":"integer","minimum":0,"maximum":100},"unit":{"type":"string","enum":["%"],"default":"%"}},"required":["value"]}}},"commands":{"setVolume":{"arguments":[{"name":"volume","schema":{"type":"integer","minimum":0,"maximum":100},"required":true}]},"volumeUp":{"arguments":[]},"volumeDown":{"arguments":[]}}},{"id":"battery","version":1,"name":"Battery","status":"live","attributes":{"battery":{"schema":{"title":"IntegerPercent","type":"object","additionalProperties":false,"properties":{"value":{"type":"integer","minimum":0,"maximum":100},"unit":{"type":"string","enum":["%"],"default":"%"}},"required":["value"]}}},"commands":{}},{"id":"bodyMassIndexMeasurement","version":1,"name":"Body Mass Index Measurement","status":"proposed","attributes":{"bmiMeasurement":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"number"},"unit":{"type":"string","enum":["kg/m^2"],"default":"kg/m^2"}},"required":["value"]}}},"commands":{}},{"id":"bodyWeightMeasurement","version":1,"name":"Body Weight Measurement","status":"proposed","attributes":{"bodyWeightMeasurement":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"number"},"unit":{"type":"string","enum":["kg","lbs","斤"],"default":"kg"}},"required":["value","unit"]}}},"commands":{}},{"id":"button","version":1,"name":"Button","status":"live","attributes":{"button":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"ButtonState","type":"string","enum":["pushed","held","double","pushed_2x","pushed_3x","pushed_4x","pushed_5x","pushed_6x","down","down_2x","down_3x","down_4x","down_5x","down_6x","down_hold","up","up_2x","up_3x","up_4x","up_5x","up_6x","up_hold"]}},"required":["value"]}},"numberOfButtons":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"PositiveInteger","type":"integer","minimum":0}},"required":["value"]}},"supportedButtonValues":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"array","items":{"title":"ButtonState","type":"string","enum":["pushed","held","double","pushed_2x","pushed_3x","pushed_4x","pushed_5x","pushed_6x","down","down_2x","down_3x","down_4x","down_5x","down_6x","down_hold","up","up_2x","up_3x","up_4x","up_5x","up_6x","up_hold"]}}}}}},"commands":{}},{"id":"carbonDioxideMeasurement","version":1,"name":"Carbon Dioxide Measurement","status":"live","attributes":{"carbonDioxide":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"integer","minimum":0,"maximum":1000000},"unit":{"type":"string","enum":["ppm"],"default":"ppm"}},"required":["value"]}}},"commands":{}},{"id":"carbonMonoxideDetector","version":1,"name":"Carbon Monoxide Detector","status":"live","attributes":{"carbonMonoxide":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"CarbonMonoxideState","type":"string","enum":["clear","detected","tested"]}},"required":["value"]}}},"commands":{}},{"id":"carbonMonoxideMeasurement","version":1,"name":"Carbon Monoxide Measurement","status":"proposed","attributes":{"carbonMonoxideLevel":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"number","minimum":0,"maximum":1000000},"unit":{"type":"string","enum":["ppm"],"default":"ppm"}},"required":["value","unit"]}}},"commands":{}},{"id":"colorControl","version":1,"name":"Color Control","status":"live","attributes":{"color":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"String","type":"string","maxLength":255}}}},"hue":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"PositiveNumber","type":"number","minimum":0}}}},"saturation":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"PositiveNumber","type":"number","minimum":0}}}}},"commands":{"setColor":{"arguments":[{"name":"color","schema":{"title":"COLOR_MAP","type":"object","additionalProperties":false,"properties":{"hue":{"type":"number"},"saturation":{"type":"number"},"hex":{"type":"string","maxLength":7},"level":{"type":"integer"},"switch":{"type":"string","maxLength":3}}},"required":true}]},"setHue":{"arguments":[{"name":"hue","schema":{"title":"PositiveNumber","type":"number","minimum":0},"required":true}]},"setSaturation":{"arguments":[{"name":"saturation","schema":{"title":"PositiveNumber","type":"number","minimum":0},"required":true}]}}},{"id":"colorTemperature","version":1,"name":"Color Temperature","status":"live","attributes":{"colorTemperature":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"integer","minimum":1,"maximum":30000},"unit":{"type":"string","enum":["K"],"default":"K"}},"required":["value"]}}},"commands":{"setColorTemperature":{"arguments":[{"name":"temperature","schema":{"type":"integer","minimum":1,"maximum":30000},"required":true}]}}},{"id":"contactSensor","version":1,"name":"Contact Sensor","status":"live","attributes":{"contact":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"ContactState","type":"string","enum":["closed","open"]}},"required":["value"]}}},"commands":{}},{"id":"dishwasherMode","version":1,"name":"Dishwasher Mode","status":"proposed","attributes":{"dishwasherMode":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"DishwasherMode","type":"string","enum":["auto","quick","rinse","dry"]}},"required":["value"]}}},"commands":{"setDishwasherMode":{"arguments":[{"name":"mode","schema":{"title":"DishwasherMode","type":"string","enum":["auto","quick","rinse","dry"]},"required":true}]}}},{"id":"dishwasherOperatingState","version":1,"name":"Dishwasher Operating State","status":"proposed","attributes":{"machineState":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"MachineState","type":"string","enum":["pause","run","stop"]},"constraints":{"type":"object","additionalProperties":false,"properties":{"values":{"type":"array","items":{"title":"MachineState","type":"string","enum":["pause","run","stop"]}}}}},"required":["value"]}},"supportedMachineStates":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"array","items":{"title":"MachineState","type":"string","enum":["pause","run","stop"]}}},"required":["value"]}},"dishwasherJobState":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"DishwasherJobState","type":"string","enum":["airwash","cooling","drying","finish","preDrain","prewash","rinse","spin","unknown","wash","wrinklePrevent"]},"constraints":{"type":"object","additionalProperties":false,"properties":{"values":{"type":"array","items":{"title":"DishwasherJobState","type":"string","enum":["airwash","cooling","drying","finish","preDrain","prewash","rinse","spin","unknown","wash","wrinklePrevent"]}}}}},"required":["value"]}},"completionTime":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"Iso8601Date","type":"string","pattern":"^(?:[1-9]\\d{3}-?(?:(?:0[1-9]|1[0-2])-?(?:0[1-9]|1\\d|2[0-8])|(?:0[13-9]|1[0-2])-?(?:29|30)|(?:0[13578]|1[02])-?31)|(?:[1-9]\\d(?:0[48]|[2468][048]|[13579][26])|(?:[2468][048]|[13579][26])00)-?02-?29)T(?:[01]\\d|2[0-3]):?[0-5]\\d:?[0-5]\\d(?:\\.\\d{3})?(?:Z|[+-][01]\\d(?::?[0-5]\\d)?)$"}},"required":["value"]}}},"commands":{"setMachineState":{"arguments":[{"name":"state","schema":{"title":"MachineState","type":"string","enum":["pause","run","stop"]},"required":true}]}}},{"id":"doorControl","version":1,"name":"Door Control","status":"live","attributes":{"door":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"string","enum":["closed","closing","open","opening","unknown"]},"constraints":{"type":"object","additionalProperties":false,"properties":{"values":{"type":"array","items":{"type":"string","enum":["closed","closing","open","opening","unknown"]}}}}},"required":["value"]}}},"commands":{"close":{"arguments":[]},"open":{"arguments":[]}}},{"id":"dryerMode","version":1,"name":"Dryer Mode","status":"proposed","attributes":{"dryerMode":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"DryerMode","type":"string","enum":["regular","lowHeat","highHeat"]},"constraints":{"type":"object","additionalProperties":false,"properties":{"values":{"type":"array","items":{"title":"DryerMode","type":"string","enum":["regular","lowHeat","highHeat"]}}}}},"required":["value"]}}},"commands":{"setDryerMode":{"arguments":[{"name":"mode","schema":{"title":"DryerMode","type":"string","enum":["regular","lowHeat","highHeat"]},"required":true}]}}},{"id":"dryerOperatingState","version":1,"name":"Dryer Operating State","status":"proposed","attributes":{"machineState":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"MachineState","type":"string","enum":["pause","run","stop"]},"constraints":{"type":"object","additionalProperties":false,"properties":{"values":{"type":"array","items":{"title":"MachineState","type":"string","enum":["pause","run","stop"]}}}}},"required":["value"]}},"supportedMachineStates":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"array","items":{"title":"MachineState","type":"string","enum":["pause","run","stop"]}}},"required":["value"]}},"dryerJobState":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"DryerJobState","type":"string","enum":["cooling","delayWash","drying","finished","none","weightSensing","wrinklePrevent"]},"constraints":{"type":"object","additionalProperties":false,"properties":{"values":{"type":"array","items":{"title":"DryerJobState","type":"string","enum":["cooling","delayWash","drying","finished","none","weightSensing","wrinklePrevent"]}}}}},"required":["value"]}},"completionTime":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"Iso8601Date","type":"string","pattern":"^(?:[1-9]\\d{3}-?(?:(?:0[1-9]|1[0-2])-?(?:0[1-9]|1\\d|2[0-8])|(?:0[13-9]|1[0-2])-?(?:29|30)|(?:0[13578]|1[02])-?31)|(?:[1-9]\\d(?:0[48]|[2468][048]|[13579][26])|(?:[2468][048]|[13579][26])00)-?02-?29)T(?:[01]\\d|2[0-3]):?[0-5]\\d:?[0-5]\\d(?:\\.\\d{3})?(?:Z|[+-][01]\\d(?::?[0-5]\\d)?)$"}},"required":["value"]}}},"commands":{"setMachineState":{"arguments":[{"name":"state","schema":{"title":"MachineState","type":"string","enum":["pause","run","stop"]},"required":true}]}}},{"id":"dustSensor","version":1,"name":"Dust Sensor","status":"live","attributes":{"fineDustLevel":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"PositiveInteger","type":"integer","minimum":0},"unit":{"type":"string","enum":["μg/m^3"],"default":"μg/m^3"}},"required":["value"]}},"dustLevel":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"PositiveInteger","type":"integer","minimum":0},"unit":{"type":"string","enum":["μg/m^3"],"default":"μg/m^3"}},"required":["value"]}}},"commands":{}},{"id":"energyMeter","version":1,"name":"Energy Meter","status":"live","attributes":{"energy":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"number"},"unit":{"type":"string","enum":["kWh"],"default":"kWh"}},"required":["value"]}}},"commands":{}},{"id":"equivalentCarbonDioxideMeasurement","version":1,"name":"Equivalent Carbon Dioxide Measurement","status":"live","attributes":{"equivalentCarbonDioxideMeasurement":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"number","minimum":0,"maximum":1000000},"unit":{"type":"string","enum":["ppm"],"default":"ppm"}},"required":["value"]}}},"commands":{}},{"id":"fanSpeed","version":1,"name":"Fan Speed","status":"proposed","attributes":{"fanSpeed":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"PositiveInteger","type":"integer","minimum":0}},"required":["value"]}}},"commands":{"setFanSpeed":{"arguments":[{"name":"speed","schema":{"title":"PositiveInteger","type":"integer","minimum":0},"required":true}]}}},{"id":"filterStatus","version":1,"name":"Filter Status","status":"proposed","attributes":{"filterStatus":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"string","enum":["normal","replace"]}},"required":["value"]}}},"commands":{}},{"id":"formaldehydeMeasurement","version":1,"name":"Formaldehyde Measurement","status":"live","attributes":{"formaldehydeLevel":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"number","minimum":0,"maximum":1000000},"unit":{"type":"string","enum":["ppm","mg/m^3"],"default":"ppm"}},"required":["value","unit"]}}},"commands":{}},{"id":"garageDoorControl","version":1,"name":"Garage Door Control","status":"deprecated","attributes":{"door":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"string","enum":["closed","closing","open","opening","unknown"]},"constraints":{"type":"object","additionalProperties":false,"properties":{"values":{"type":"array","items":{"type":"string","enum":["closed","closing","open","opening","unknown"]}}}}},"required":["value"]}}},"commands":{"close":{"arguments":[]},"open":{"arguments":[]}}},{"id":"illuminanceMeasurement","version":1,"name":"Illuminance Measurement","status":"live","attributes":{"illuminance":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"number","minimum":0,"maximum":100000},"unit":{"type":"string","enum":["lux"],"default":"lux"}},"required":["value"]}}},"commands":{}},{"id":"infraredLevel","version":1,"name":"Infrared Level","status":"live","attributes":{"infraredLevel":{"schema":{"title":"Percent","type":"object","additionalProperties":false,"properties":{"value":{"type":"number","minimum":0,"maximum":100},"unit":{"type":"string","enum":["%"],"default":"%"}},"required":["value"]}}},"commands":{"setInfraredLevel":{"arguments":[{"name":"level","schema":{"type":"number","minimum":0,"maximum":100},"required":true}]}}},{"id":"lock","version":1,"name":"Lock","status":"live","attributes":{"lock":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"LockState","type":"string","enum":["locked","unknown","unlocked","unlocked with timeout"]},"data":{"type":"object","additionalProperties":false,"properties":{"method":{"type":"string","enum":["manual","keypad","auto","command","rfid","fingerprint","bluetooth"]},"codeId":{"type":"string"},"timeout":{"title":"Iso8601Date","type":"string","pattern":"^(?:[1-9]\\d{3}-?(?:(?:0[1-9]|1[0-2])-?(?:0[1-9]|1\\d|2[0-8])|(?:0[13-9]|1[0-2])-?(?:29|30)|(?:0[13578]|1[02])-?31)|(?:[1-9]\\d(?:0[48]|[2468][048]|[13579][26])|(?:[2468][048]|[13579][26])00)-?02-?29)T(?:[01]\\d|2[0-3]):?[0-5]\\d:?[0-5]\\d(?:\\.\\d{3})?(?:Z|[+-][01]\\d(?::?[0-5]\\d)?)$"}}}},"required":["value"]}}},"commands":{"lock":{"arguments":[]},"unlock":{"arguments":[]}}},{"id":"mediaInputSource","version":1,"name":"Media Input Source","status":"proposed","attributes":{"inputSource":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"MediaSource","type":"string","enum":["AM","CD","FM","HDMI","HDMI1","HDMI2","HDMI3","HDMI4","HDMI5","HDMI6","digitalTv","USB","YouTube","aux","bluetooth","digital","melon","wifi"]}},"required":["value"]}},"supportedInputSources":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"array","items":{"title":"MediaSource","type":"string","enum":["AM","CD","FM","HDMI","HDMI1","HDMI2","HDMI3","HDMI4","HDMI5","HDMI6","digitalTv","USB","YouTube","aux","bluetooth","digital","melon","wifi"]}}},"required":["value"]}}},"commands":{"setInputSource":{"arguments":[{"name":"mode","schema":{"title":"MediaSource","type":"string","enum":["AM","CD","FM","HDMI","HDMI1","HDMI2","HDMI3","HDMI4","HDMI5","HDMI6","digitalTv","USB","YouTube","aux","bluetooth","digital","melon","wifi"]},"required":true}]}}},{"id":"mediaPlaybackRepeat","version":1,"name":"Media Playback Repeat","status":"proposed","attributes":{"playbackRepeatMode":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"string","enum":["all","off","one"]}},"required":["value"]}}},"commands":{"setPlaybackRepeatMode":{"arguments":[{"name":"mode","schema":{"type":"string","enum":["all","off","one"]},"required":true}]}}},{"id":"mediaPlaybackShuffle","version":1,"name":"Media Playback Shuffle","status":"proposed","attributes":{"playbackShuffle":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"string","enum":["disabled","enabled"]}},"required":["value"]}}},"commands":{"setPlaybackShuffle":{"arguments":[{"name":"shuffle","schema":{"type":"string","enum":["disabled","enabled"]},"required":true}]}}},{"id":"mediaPlayback","version":1,"name":"Media Playback","status":"proposed","attributes":{"playbackStatus":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"string","enum":["pause","play","stop","fast forward","rewind"]}}}},"supportedPlaybackCommands":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"array","items":{"title":"MediaPlaybackCommands","type":"string","enum":["pause","play","stop","fastForward","rewind"]}}}}}},"commands":{"setPlaybackStatus":{"arguments":[{"name":"status","schema":{"type":"string","enum":["pause","play","stop","fast forward","rewind"]},"required":true}]},"play":{"arguments":[]},"pause":{"arguments":[]},"stop":{"arguments":[]},"fastForward":{"arguments":[]},"rewind":{"arguments":[]}}},{"id":"motionSensor","version":1,"name":"Motion Sensor","status":"live","attributes":{"motion":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"ActivityState","type":"string","enum":["active","inactive"]}},"required":["value"]}}},"commands":{}},{"id":"odorSensor","version":1,"name":"Odor Sensor","status":"proposed","attributes":{"odorLevel":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"PositiveInteger","type":"integer","minimum":0}},"required":["value"]}}},"commands":{}},{"id":"ovenMode","version":1,"name":"Oven Mode","status":"proposed","attributes":{"ovenMode":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"string","enum":["heating","grill","warming","defrosting"]},"constraints":{"constraints":{"type":"object","additionalProperties":false,"properties":{"values":{"type":"array","items":{"type":"string","enum":["heating","grill","warming","defrosting"]}}}}}},"required":["value"]}}},"commands":{"setOvenMode":{"arguments":[{"name":"mode","schema":{"type":"string","enum":["heating","grill","warming","defrosting"]},"required":true}]}}},{"id":"ovenOperatingState","version":1,"name":"Oven Operating State","status":"proposed","attributes":{"machineState":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"string","enum":["ready","running","paused"]}}}},"supportedMachineStates":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"array","items":{"type":"string","enum":["ready","running","paused"]}}}}},"ovenJobState":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"string","enum":["cleaning","cooking","cooling","draining","preheat","ready","rinsing"]}}}},"completionTime":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"Iso8601Date","type":"string","pattern":"^(?:[1-9]\\d{3}-?(?:(?:0[1-9]|1[0-2])-?(?:0[1-9]|1\\d|2[0-8])|(?:0[13-9]|1[0-2])-?(?:29|30)|(?:0[13578]|1[02])-?31)|(?:[1-9]\\d(?:0[48]|[2468][048]|[13579][26])|(?:[2468][048]|[13579][26])00)-?02-?29)T(?:[01]\\d|2[0-3]):?[0-5]\\d:?[0-5]\\d(?:\\.\\d{3})?(?:Z|[+-][01]\\d(?::?[0-5]\\d)?)$"}},"required":["value"]}},"operationTime":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"PositiveInteger","type":"integer","minimum":0}}}},"progress":{"schema":{"title":"IntegerPercent","type":"object","additionalProperties":false,"properties":{"value":{"type":"integer","minimum":0,"maximum":100},"unit":{"type":"string","enum":["%"],"default":"%"}},"required":["value"]}}},"commands":{"setMachineState":{"arguments":[{"name":"state","schema":{"type":"string","enum":["stop"]},"required":true}]},"stop":{"arguments":[]}}},{"id":"ovenSetpoint","version":1,"name":"Oven Setpoint","status":"proposed","attributes":{"ovenSetpoint":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"PositiveInteger","type":"integer","minimum":0}},"required":["value"]}}},"commands":{"setOvenSetpoint":{"arguments":[{"name":"setpoint","schema":{"title":"PositiveInteger","type":"integer","minimum":0},"required":true}]}}},{"id":"powerMeter","version":1,"name":"Power Meter","status":"live","attributes":{"power":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"number"},"unit":{"type":"string","enum":["W"],"default":"W"}},"required":["value"]}}},"commands":{}},{"id":"powerSource","version":1,"name":"Power Source","status":"live","attributes":{"powerSource":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"string","enum":["battery","dc","mains","unknown"]}},"required":["value"]}}},"commands":{}},{"id":"presenceSensor","version":1,"name":"Presence Sensor","status":"live","attributes":{"presence":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"PresenceState","type":"string","enum":["present","not present"]}},"required":["value"]}}},"commands":{}},{"id":"rapidCooling","version":1,"name":"Rapid Cooling","status":"proposed","attributes":{"rapidCooling":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"string","enum":["off","on"]}},"required":["value"]}}},"commands":{"setRapidCooling":{"arguments":[{"name":"rapidCooling","schema":{"type":"string","enum":["off","on"]},"required":true}]}}},{"id":"refrigerationSetpoint","version":1,"name":"Refrigeration Setpoint","status":"proposed","attributes":{"refrigerationSetpoint":{"schema":{"title":"Temperature","type":"object","additionalProperties":false,"properties":{"value":{"title":"TemperatureValue","type":"number","minimum":-460,"maximum":10000},"unit":{"title":"TemperatureUnit","type":"string","enum":["F","C"]},"constraints":{"title":"NumberConstraint","type":"object","additionalProperties":false,"properties":{"min":{"type":"number"},"max":{"type":"number"}}}},"required":["value","unit"]}}},"commands":{"setRefrigerationSetpoint":{"arguments":[{"name":"setpoint","schema":{"title":"TemperatureValue","type":"number","minimum":-460,"maximum":10000},"required":true}]}}},{"id":"relativeHumidityMeasurement","version":1,"name":"Relative Humidity Measurement","status":"live","attributes":{"humidity":{"schema":{"title":"Percent","type":"object","additionalProperties":false,"properties":{"value":{"type":"number","minimum":0,"maximum":100},"unit":{"type":"string","enum":["%"],"default":"%"}},"required":["value"]}}},"commands":{}},{"id":"robotCleanerCleaningMode","version":1,"name":"Robot Cleaner Cleaning Mode","status":"proposed","attributes":{"robotCleanerCleaningMode":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"string","enum":["auto","part","repeat","manual","stop","map"]}},"required":["value"]}}},"commands":{"setRobotCleanerCleaningMode":{"arguments":[{"name":"mode","schema":{"type":"string","enum":["auto","part","repeat","manual","stop"]},"required":true}]}}},{"id":"robotCleanerMovement","version":1,"name":"Robot Cleaner Movement","status":"proposed","attributes":{"robotCleanerMovement":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"string","enum":["homing","idle","charging","alarm","powerOff","reserve","point","after","cleaning"]}},"required":["value"]}}},"commands":{"setRobotCleanerMovement":{"arguments":[{"name":"mode","schema":{"type":"string","enum":["homing","idle","charging","alarm","powerOff","reserve","point","after","cleaning"]},"required":true}]}}},{"id":"robotCleanerTurboMode","version":1,"name":"Robot Cleaner Turbo Mode","status":"proposed","attributes":{"robotCleanerTurboMode":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"string","enum":["on","off","silence"]}},"required":["value"]}}},"commands":{"setRobotCleanerTurboMode":{"arguments":[{"name":"mode","schema":{"type":"string","enum":["on","off","silence"]},"required":true}]}}},{"id":"signalStrength","version":1,"name":"Signal Strength","status":"live","attributes":{"lqi":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"integer","minimum":0,"maximum":255}},"required":["value"]}},"rssi":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"number","minimum":-200,"maximum":0},"unit":{"type":"string","enum":["dBm"],"default":"dBm"}},"required":["value"]}}},"commands":{}},{"id":"smokeDetector","version":1,"name":"Smoke Detector","status":"live","attributes":{"smoke":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"string","enum":["clear","detected","tested"]}},"required":["value"]}}},"commands":{}},{"id":"soundSensor","version":1,"name":"Sound Sensor","status":"live","attributes":{"sound":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"string","enum":["detected","not detected"]}},"required":["value"]}}},"commands":{}},{"id":"switchLevel","version":1,"name":"Switch Level","status":"live","attributes":{"level":{"schema":{"title":"IntegerPercent","type":"object","additionalProperties":false,"properties":{"value":{"type":"integer","minimum":0,"maximum":100},"unit":{"type":"string","enum":["%"],"default":"%"}},"required":["value"]}}},"commands":{"setLevel":{"arguments":[{"name":"level","schema":{"type":"integer","minimum":0,"maximum":100},"required":true},{"name":"rate","schema":{"title":"PositiveInteger","type":"integer","minimum":0},"required":false}]}}},{"id":"switch","version":1,"name":"Switch","status":"live","attributes":{"switch":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"SwitchState","type":"string","enum":["on","off"]}},"required":["value"]}}},"commands":{"off":{"arguments":[]},"on":{"arguments":[]}}},{"id":"tamperAlert","version":1,"name":"Tamper Alert","status":"live","attributes":{"tamper":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"string","enum":["clear","detected"]}},"required":["value"]}}},"commands":{}},{"id":"temperatureMeasurement","version":1,"name":"Temperature Measurement","status":"live","attributes":{"temperature":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"TemperatureValue","type":"number","minimum":-460,"maximum":10000},"unit":{"title":"TemperatureUnit","type":"string","enum":["F","C"]}},"required":["value","unit"]}}},"commands":{}},{"id":"thermostatCoolingSetpoint","version":1,"name":"Thermostat Cooling Setpoint","status":"live","attributes":{"coolingSetpoint":{"schema":{"title":"Temperature","type":"object","additionalProperties":false,"properties":{"value":{"title":"TemperatureValue","type":"number","minimum":-460,"maximum":10000},"unit":{"title":"TemperatureUnit","type":"string","enum":["F","C"]},"constraints":{"title":"NumberConstraint","type":"object","additionalProperties":false,"properties":{"min":{"type":"number"},"max":{"type":"number"}}}},"required":["value","unit"]}}},"commands":{"setCoolingSetpoint":{"arguments":[{"name":"setpoint","schema":{"title":"TemperatureValue","type":"number","minimum":-460,"maximum":10000},"required":true}]}}},{"id":"thermostatFanMode","version":1,"name":"Thermostat Fan Mode","status":"live","attributes":{"thermostatFanMode":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"ThermostatFanMode","type":"string","enum":["auto","circulate","followschedule","on"]}},"required":["value"]}},"supportedThermostatFanModes":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"array","items":{"title":"ThermostatFanMode","type":"string","enum":["auto","circulate","followschedule","on"]}}}}}},"commands":{"fanAuto":{"arguments":[]},"fanCirculate":{"arguments":[]},"fanOn":{"arguments":[]},"setThermostatFanMode":{"arguments":[{"name":"mode","schema":{"title":"ThermostatFanMode","type":"string","enum":["auto","circulate","followschedule","on"]},"required":true}]}}},{"id":"thermostatHeatingSetpoint","version":1,"name":"Thermostat Heating Setpoint","status":"live","attributes":{"heatingSetpoint":{"schema":{"title":"Temperature","type":"object","additionalProperties":false,"properties":{"value":{"title":"TemperatureValue","type":"number","minimum":-460,"maximum":10000},"unit":{"title":"TemperatureUnit","type":"string","enum":["F","C"]},"constraints":{"title":"NumberConstraint","type":"object","additionalProperties":false,"properties":{"min":{"type":"number"},"max":{"type":"number"}}}},"required":["value","unit"]}}},"commands":{"setHeatingSetpoint":{"arguments":[{"name":"setpoint","schema":{"title":"TemperatureValue","type":"number","minimum":-460,"maximum":10000},"required":true}]}}},{"id":"thermostatMode","version":1,"name":"Thermostat Mode","status":"live","attributes":{"thermostatMode":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"ThermostatMode","type":"string","enum":["auto","cool","eco","rush hour","emergency heat","heat","off"]}},"required":["value"]}},"supportedThermostatModes":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"array","items":{"title":"ThermostatMode","type":"string","enum":["auto","cool","eco","rush hour","emergency heat","heat","off"]}}}}}},"commands":{"auto":{"arguments":[]},"cool":{"arguments":[]},"emergencyHeat":{"arguments":[]},"heat":{"arguments":[]},"off":{"arguments":[]},"setThermostatMode":{"arguments":[{"name":"mode","schema":{"title":"ThermostatMode","type":"string","enum":["auto","cool","eco","rush hour","emergency heat","heat","off"]},"required":true}]}}},{"id":"thermostatOperatingState","version":1,"name":"Thermostat Operating State","status":"live","attributes":{"thermostatOperatingState":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"ThermostatOperatingState","type":"string","enum":["cooling","fan only","heating","idle","pending cool","pending heat","vent economizer"]},"constraints":{"title":"EnumConstraint","properties":{"values":{"type":"array"}}}},"required":["value"]}}},"commands":{}},{"id":"thermostatSetpoint","version":1,"name":"Thermostat Setpoint","status":"deprecated","attributes":{"thermostatSetpoint":{"schema":{"title":"Temperature","type":"object","additionalProperties":false,"properties":{"value":{"title":"TemperatureValue","type":"number","minimum":-460,"maximum":10000},"unit":{"title":"TemperatureUnit","type":"string","enum":["F","C"]},"constraints":{"title":"NumberConstraint","type":"object","additionalProperties":false,"properties":{"min":{"type":"number"},"max":{"type":"number"}}}},"required":["value","unit"]}}},"commands":{}},{"id":"tone","version":1,"name":"Tone","status":"live","attributes":{},"commands":{"beep":{"arguments":[]}}},{"id":"tvChannel","version":1,"name":"Tv Channel","status":"proposed","attributes":{"tvChannel":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"String","type":"string","maxLength":255}}}}},"commands":{"setTvChannel":{"arguments":[{"name":"channel","schema":{"title":"String","type":"string","maxLength":255},"required":true}]},"channelUp":{"arguments":[]},"channelDown":{"arguments":[]}}},{"id":"tvocMeasurement","version":1,"name":"Tvoc Measurement","status":"live","attributes":{"tvocLevel":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"number","minimum":0,"maximum":1000000},"unit":{"type":"string","enum":["ppm"],"default":"ppm"}},"required":["value","unit"]}}},"commands":{}},{"id":"ultravioletIndex","version":1,"name":"Ultraviolet Index","status":"live","attributes":{"ultravioletIndex":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"number","minimum":0,"maximum":255}},"required":["value"]}}},"commands":{}},{"id":"valve","version":1,"name":"Valve","status":"live","attributes":{"valve":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"string","enum":["closed","open"]}},"required":["value"]}}},"commands":{"close":{"arguments":[]},"open":{"arguments":[]}}},{"id":"voltageMeasurement","version":1,"name":"Voltage Measurement","status":"live","attributes":{"voltage":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"Number","type":"number"},"unit":{"type":"string","enum":["V"],"default":"V"}},"required":["value"]}}},"commands":{}},{"id":"washerMode","version":1,"name":"Washer Mode","status":"proposed","attributes":{"washerMode":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"WasherMode","type":"string","enum":["regular","heavy","rinse","spinDry"]}},"required":["value"]}}},"commands":{"setWasherMode":{"arguments":[{"name":"mode","schema":{"title":"WasherMode","type":"string","enum":["regular","heavy","rinse","spinDry"]},"required":true}]}}},{"id":"washerOperatingState","version":1,"name":"Washer Operating State","status":"proposed","attributes":{"machineState":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"MachineState","type":"string","enum":["pause","run","stop"]}},"required":["value"]}},"supportedMachineStates":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"array","items":{"title":"MachineState","type":"string","enum":["pause","run","stop"]}}}}},"washerJobState":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"type":"string","enum":["airWash","cooling","delayWash","drying","finish","none","preWash","rinse","spin","wash","weightSensing","wrinklePrevent"]},"constraints":{"type":"object","additionalProperties":false,"properties":{"values":{"type":"array","items":{"type":"string","enum":["airWash","cooling","delayWash","drying","finish","none","preWash","rinse","spin","wash","weightSensing","wrinklePrevent"]}}}}},"required":["value"]}},"completionTime":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"Iso8601Date","type":"string","pattern":"^(?:[1-9]\\d{3}-?(?:(?:0[1-9]|1[0-2])-?(?:0[1-9]|1\\d|2[0-8])|(?:0[13-9]|1[0-2])-?(?:29|30)|(?:0[13578]|1[02])-?31)|(?:[1-9]\\d(?:0[48]|[2468][048]|[13579][26])|(?:[2468][048]|[13579][26])00)-?02-?29)T(?:[01]\\d|2[0-3]):?[0-5]\\d:?[0-5]\\d(?:\\.\\d{3})?(?:Z|[+-][01]\\d(?::?[0-5]\\d)?)$"}},"required":["value"]}}},"commands":{"setMachineState":{"arguments":[{"name":"state","schema":{"title":"MachineState","type":"string","enum":["pause","run","stop"]},"required":true}]}}},{"id":"waterSensor","version":1,"name":"Water Sensor","status":"live","attributes":{"water":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"MoistureState","type":"string","enum":["dry","wet"]}},"required":["value"]}}},"commands":{}},{"id":"windowShade","version":1,"name":"Window Shade","status":"proposed","attributes":{"windowShade":{"schema":{"type":"object","additionalProperties":false,"properties":{"value":{"title":"OpenableState","type":"string","enum":["closed","closing","open","opening","partially open","unknown"]},"constraints":{"type":"object","additionalProperties":false,"properties":{"values":{"type":"array","items":{"title":"OpenableState","type":"string","enum":["closed","closing","open","opening","partially open","unknown"]}}}}},"required":["value"]}}},"commands":{"close":{"arguments":[]},"open":{"arguments":[]},"presetPosition":{"arguments":[]}}}]
        var _capabilities = {}
        _raw_capabilities.forEach(function (capa) {
            if (capa.attributes && Object.keys(capa.attributes).length == 0) {
                delete capa.attributes
            }
            if (capa.commands && Object.keys(capa.commands).length == 0) {
                delete capa.commands
            }
            if (capa.status === 'live' || capa.status === 'proposed') {
                _capabilities[capa.id] = capa
            }
        })

        this.getAttributeSchema = function (capabilityId, attributeId) {
            if (_capabilities[capabilityId] && _capabilities[capabilityId].attributes && _capabilities[capabilityId].attributes[attributeId]) {
                return _capabilities[capabilityId].attributes[attributeId].schema || {}
            } else {
                return {}
            }
        }
        this.getCommandArguments = function (capabilityId, commandId) {
            if (_capabilities[capabilityId] && _capabilities[capabilityId].commands && _capabilities[capabilityId].commands[commandId]) {
                return _capabilities[capabilityId].commands[commandId].arguments || []
            } else {
                return []
            }
        }

        this.getCapability = function (cp) {
            return _capabilities[cp] || {}
        }

        this.getAllCapabilities = function () {
            return _capabilities;
        };

        var _jsonclone = function (obj) {
            try {
                return JSON.parse(JSON.stringify(obj))
            } catch (err) {
                console.log(err)
                return {}
            }
        }
    }

    var validateAutomationNext = function (id) {
        //Automation 뒤에는 on device(event) 만 올 수 있다 (input 1, 해당 input port 에 연결된 wires 도 하나)
        var backLinks = RED.nodes.filterLinks({"source": {"id": id}})
        if (backLinks.length != 1) return false
        if (backLinks[0].target["type"] !== "event-device") return false
        return true
    }

    var profiles = new Profiles();
</script>
<!-- Node Common Script End-->

<!-- Node Script -->
<script type="text/javascript">
    const ST_EVENT_DEVICE = "event-device";
    const ST_STATUS_DEVICE = "status-device";
    const ST_COMMAND_DEVICE = "command-device";
    const ST_DEVICE_PROFILE = 'device-profile';
    const ST_MY_DEVICE = 'installed-device';
    const ST_AUTOMATION = 'automation';
    // const ST_NODE_VERSION = 200330
    var stDevice = {};

    RED.nodes.registerType(ST_DEVICE_PROFILE, {
        category: "Samsung AutomationStudio",
        paletteLabel: "Device Profile",
        color: "rgb(168,168,168)",
        defaults: {
            bid: {value:''},
            name: {value: "", required: true},
            capabilityId: {value: "", required: true},
            capability:{value:''}
        },
        inputs: 0,
        outputs: 0,
        icon: "deviceprofile.png",
        label: function () {
            if (this.name) {
                return this.name + ":" + this.capabilityId;
            } else {
                return "Device Profile";
            }
        },
        oneditprepare: function () {
            var NODE = this
            if(NODE.bid===''){
                NODE.bid=NODE.id
            }

            $("#node-input-capabilityId").empty();
            $("#node-input-capabilityId").append($("<option></option>").val("").text(""));
            Object.keys(profiles.getAllCapabilities())
                .forEach(function (capability) {
                    $("<option></option>").val(capability).text(capability).appendTo(("#node-input-capabilityId"))
                })
            $("#node-input-capabilityId").val(NODE.capabilityId);
        }
    });

    RED.nodes.registerType(ST_MY_DEVICE, {
        category: "Samsung AutomationStudio",
        paletteLabel: "My Device",
        color: "rgb(231,147,173)",
        defaults: {
            bid: {value:''},
            name: {value: "", required: true},
            label: {value: ""},
            device: {value:''}
        },
        credentials: {
            stAccessToken: {type: 'text', required: true}
        },
        inputs: 0,
        outputs: 0,
        icon: "mydevice.png",
        label: function () {
            if (this.label) {
                return "My Device:" + this.label
            } else {
                return "My Device"
            }
        },
        oneditprepare: function () {
            var NODE = this;
            if(NODE.bid===''){
                NODE.bid=NODE.id
            }

            $("#my-device-list-container")
                .css('min-height', '400px')
                .css('min-width', '150px')
                .editableList({
                    addButton: "GET SmartThings Device List",
                    addItem: function (row, index, data) {
                        var device = data || {}

                        row.data('device', device)
                        $('<div>').text(device.label).css('font-weight', 'bold').appendTo(row)

                        device.capabilities = []
                        if (Array.isArray(device.components)) {
                            device.components.forEach(function (component) {
                                if (Array.isArray(component.capabilities)) {
                                    component.capabilities.forEach(function (capability) {
                                        device.capabilities.push(capability.id)
                                    })
                                }
                            })
                        }
                        $('<div>').text(device.capabilities.join(", ")).appendTo(row)

                        var selectButton = $('<a/>', {href: "#", class: "red-ui-editableList-item-remove editor-button editor-button-small"}).appendTo(row)
                        selectButton.text('select')
                        selectButton.on('click', function () {
                            $('#my-device-list-container .history-stack-selected').removeClass('history-stack-selected')
                            var device = row.data('device')
                            $('#node-input-name').val(device.name)
                            $('#node-input-label').val(device.label)
                            NODE.device = device
                        })
                    },
                    resizeItem: function (container) {
                    },
                    removeItem: function (opt) {
                    },
                    sortItems: function (rules) {
                    },
                    sortable: true,
                    removable: false
                });

            var getItemsFail = function (err) {
                $('#node-input-stAccessToken').addClass('input-error')
                var failMsg = document.createElement('span');
                failMsg.setAttribute('id', 'getDeviceListErrMsg');
                failMsg.style.color = 'red';
                failMsg.style.paddingLeft = '10px';
                failMsg.style.fontsize = '12px';
                failMsg.style.fontWeight = 'bold';
                failMsg.innerText = err.status + ', ' + err.statusText;

                document.querySelector("#my-device-list-div > div > a").insertAdjacentElement('afterend', failMsg);
                var duration = 3000;
                $('#getDeviceListErrMsg').fadeOut(duration, function () {
                    $(this).remove();
                })
            }

            var addItems = function (list) {
                if (list && Array.isArray(list)) {
                    list.sort(function (a, b) {
                        return (a.label > b.label) ? 1 : (a.label == b.label) ? 0 : -1
                    })
                    $('#my-device-list-container').empty()
                    list.forEach(function (device) {
                        $('#my-device-list-container').editableList('addItem', device)
                    })
                }
            }
            var getItemsSuccess = function (list) {
                $('#node-input-stAccessToken').removeClass('input-error')
                NODE.deviceList = list
                addItems(list)
            }
            $('#my-device-list-div > div > a.editor-button,a.red-ui-button').off('click');
            $('#my-device-list-div > div > a.editor-button,a.red-ui-button').on('click', function (evt) {
                evt.preventDefault();
                var token = $('#node-input-stAccessToken').val();
                SmartThingsApi.getDeviceList(token, getItemsSuccess, getItemsFail);
            })
            if (NODE.deviceList && NODE.deviceList.length > 0) {
                addItems(NODE.deviceList)
            } else if (NODE.credentials.stAccessToken) {
                SmartThingsApi.getDeviceList(NODE.credentials.stAccessToken, getItemsSuccess, getItemsFail)
            }

            if (!NODE.credentials.stAccessToken) {
                NODE.device = {}
                $('#node-input-name').val('')
                $('#node-input-label').val('')
                $('#my-device-list-container').empty()
            }

        },
        oneditsave: function () {
        }
    });

    RED.nodes.registerType(ST_AUTOMATION, {
        category: 'Samsung AutomationStudio',
        color: "rgb(80, 196, 253)",
        defaults: {
            name: {value: "", required: true},
            method: {value: 'post'},
            url: {
                value: "",
                required: true
            },
            urlDate: {value: ""},
            // isUniqueUrl: {value: false},
            eqtype: {
                value: "", validate: function (v) {
                    return validateAutomationNext(this.id);
                }
            },
            publickey: {value: "---PUBLIC KEY---", required: true}
        },
        inputs: 0,
        outputs: 1,
        icon: "smartapp.png",
        label: function () {
            if (this.url) {
                if (this.method) {
                    return "[" + this.method + "]" + this.url;
                } else {
                    return this.url;
                }
            } else {
                return "Automation";
            }
        },
        labelStyle: function () {
            return this.url ? "node_label_italic" : "";
        },
        paletteLabel: function () {
            return "Automation";
        },
        oneditprepare: function () {
            var NODE = this;
            var $inputUrl = $('#node-input-url')

            RED.popover.create({
                target: $('#export-clipboard'),
                content: 'copied',
                trigger: 'click',
                autoClose: 2000,
                direction: 'right',
                delay: {show: 750, hide: 2000}
            });
            var copyurl = window.location.origin + $inputUrl.val()
            if (copyurl == undefined || copyurl == "") {
                $("#node-input-copyurl").val(window.location.origin);
            } else {
                $("#node-input-copyurl").val(window.location.origin + $inputUrl.val());
            }

            var validateUrl = function () {
                var url = $inputUrl.val() || ""
                url = url.replace(/[^a-zA-Z0-9\-\_\/]/gi, '')
                url = url.replace(/[\/]{2,}/gi, '/')
                if (url.charAt(0) != '/') {
                    url = '/' + url
                }
                $inputUrl.val(url)
                $("#node-input-copyurl").val(window.location.origin + $inputUrl.val());
            }
            $inputUrl.on("keyup", validateUrl);
            $inputUrl.on("focusin", validateUrl);

            //if safari, hide clipboard button
            if (!document.queryCommandSupported("copy")) {
                $("#node-input-copyurl").parent().closest('div').css('right', '0px');
                $("#export-clipboard").hide();
            } else {
                $("#node-input-copyurl").parent().closest('div').css('right', '40px');
                $("#export-clipboard").show();
                $("#export-clipboard").on("click", function () {
                    RED.clipboard.copyText($("#node-input-copyurl").val());
                });
            }
        },
        oneditsave: function () {
            var NODE = this;
            NODE.method = 'post'
            NODE.name = $("#node-input-name").val().trim();
            if (NODE.url != $("#node-input-url").val().trim()) {
                NODE.urlDate = new Date().getTime()
                NODE.url = $("#node-input-url").val().trim()
            }
        }
    });

    var operator = {
        string: [
            {v: "eq", t: "=="},
            {v: "neq", t: "!="}
        ],
        array: [
            {v: "in", t: "contains"},
            {v: "nin", t: "not contains"}
        ],
        integer: [
            {v: "eq", t: "=="},
            {v: "neq", t: "!="},
            {v: "lt", t: "<"},
            {v: "lte", t: "<="},
            {v: "gt", t: ">"},
            {v: "gte", t: ">="}
        ],
        number: [
            {v: "eq", t: "=="},
            {v: "neq", t: "!="},
            {v: "lt", t: "<"},
            {v: "lte", t: "<="},
            {v: "gt", t: ">"},
            {v: "gte", t: ">="}
        ],
        Iso8601Date: [
            {v: "eq", t: "=="},
            {v: "neq", t: "!="},
            {v: "lt", t: "<"},
            {v: "lte", t: "<="},
            {v: "gt", t: ">"},
            {v: "gte", t: ">="}
        ]
    }

    function DeviceNodeEventHandler(formObj, node) {
        var THING = this;
        THING.node = node;
        THING.type = node.type;
        THING.form = formObj;
        THING.target = (node.type == ST_COMMAND_DEVICE) ? "commands" : "attributes"
        THING.initContainer()

        THING.initDeviceNodeSelect(node.deviceNodeId)
        THING.initCapabilitySelect(node.capabilityId)
        THING.initAttributeSelect(node.attributeId)
        THING.initAttributeContainer(node.rules)

        THING.form.deviceNodeId.on("mouseover", function () {
            THING.form.deviceNodeId.off("change")
            THING.form.deviceNodeId.on("change", function () {
                THING.initCapabilitySelect()
                THING.initAttributeSelect()
                THING.initAttributeContainer()
            })
        })

        THING.form.capabilityId.on("mouseover", function () {
            THING.form.capabilityId.off("change")
            THING.form.capabilityId.on("change", function () {
                THING.initAttributeSelect()
                THING.initAttributeContainer()
            })
        })

        THING.form.attributeId.on("mouseover", function () {
            THING.form.attributeId.off("change")
            THING.form.attributeId.on("change", function () {
                THING.initAttributeContainer()
            })
        })
    }

    DeviceNodeEventHandler.prototype = {
        initDeviceNodeSelect: function (initDeviceNodeId) {
            var deviceNodeIdSelect = this.form.deviceNodeId
            deviceNodeIdSelect.html('')
            var deviceNodeList = []
            deviceNodeList = RED.nodes.filterNodes({z: this.node.z, type: ST_DEVICE_PROFILE})
            deviceNodeList.map(function(node){
                    node.device={capabilities:[node.capabilityId]}
            })
            if (this.type != ST_EVENT_DEVICE) {
                deviceNodeList = deviceNodeList.concat(RED.nodes.filterNodes({z: this.node.z, type: ST_MY_DEVICE}))
            }
            var target = this.target
            deviceNodeList.filter(function (node) {
                if (node.name && node.device && node.device.capabilities) {
                    return node.device.capabilities.some(function (capabilityId) {
                        var capability = profiles.getCapability(capabilityId)
                        return capability && capability.hasOwnProperty(target)
                    })
                } else {
                    return false
                }
            }).forEach(function (node) {
                if (node.type == ST_DEVICE_PROFILE) {
                    deviceNodeIdSelect.prepend($("<option></option>").val(node.id).data('device', node.device).text(node.name + ":" + node.capabilityId))
                } else if (node.type == ST_MY_DEVICE) {
                    deviceNodeIdSelect.append($("<option></option>").val(node.id).data('device', node.device).text("(My)" + node.label))
                }
            })
            if (initDeviceNodeId && deviceNodeIdSelect.find('option[value="'+initDeviceNodeId+'"]').length>0) {
                deviceNodeIdSelect.val(initDeviceNodeId)
            }
        },
        //deviceid 선택시 해당 section 정보를 셋팅한다.
        initCapabilitySelect: function (initCapabilityId) {
            var capabilityIdSelect = this.form.capabilityId
            capabilityIdSelect.html('')
            var device = this.form.deviceNodeId.find('option:selected').data('device')

            if (device && device.capabilities) {
                var target = this.node.target;
                device.capabilities.forEach(function (capabilityId) {
                    //TODO:SAVE
                    if (profiles.getCapability(capabilityId).hasOwnProperty(target)) {
                        capabilityIdSelect.append($("<option></option>").val(capabilityId).text(capabilityId))
                    }
                })

                capabilityIdSelect.removeClass("input-error")
                if (capabilityIdSelect.find('option').length <= 1) {
                    capabilityIdSelect.attr('disabled', true)
                } else {
                    capabilityIdSelect.attr('disabled', false)
                }

                capabilityIdSelect.find('option:first').attr("selected", true)
            } else {
                this.form.deviceNodeId.addClass("input-error")
            }

            if (initCapabilityId && capabilityIdSelect.find('option[value="'+initCapabilityId+'"]').length>0) {
                capabilityIdSelect.val(initCapabilityId)
            }
        },
        //capability attr 셀렉트박스구성
        initAttributeSelect: function (initAttributeId) {
            var attributeIdSelect = this.form.attributeId
            attributeIdSelect.html('');

            var selectedCapabilityId = this.form.capabilityId.find("option:selected").val();

            //capability의 attributes 및 commands 정보 조회
            var capability = profiles.getCapability(selectedCapabilityId);
            if (capability && capability[this.target]) {
                Object.keys(capability[this.target]).forEach(function (attributeId) {
                    attributeIdSelect.append($("<option></option>").val(attributeId).text(attributeId));
                })
            }

            if (attributeIdSelect.find('option').length <= 1) {
                attributeIdSelect.attr('disabled', true)
                attributeIdSelect.attr('readonly', true)
            } else {
                attributeIdSelect.attr('readonly', false)
                attributeIdSelect.attr('disabled', false)
            }
            if (initAttributeId && attributeIdSelect.find('option[value="'+initAttributeId+'"]').length>0) {
                attributeIdSelect.val(initAttributeId)
            }
        },
        initContainer:function(){
            $("#cmd-list-container").css('min-height', '150px').css('min-width', '150px').editableList({
                addButton: false,
                addItem: function (container, idx, data) {
                    var capabilityId = $("#node-input-capabilityId option:selected").val()
                    var commandId = $("#node-input-attributeId option:selected").val()
                    var arguments = profiles.getCommandArguments(capabilityId, commandId)

                    var row = $('<div/>', {style: "margin-left:10px;height: auto;"}).appendTo(container);
                    $('<span>', {class: "capaId"}).appendTo(row).text(capabilityId)
                    $('<span style="font-size: 20px; font-weight: bold;">.</span>').appendTo(row)
                    $('<span>', {class: "attrId"}).appendTo(row).text(commandId)
                    var argNames = arguments.map(function (arg) {
                        return arg.name
                    }).join(', ')
                    $('<span>').appendTo(row).text(' ( ' + argNames + ' )')

                    if (arguments.length > 0) {
                        arguments.forEach(function (arg) {
                            var row2 = $('<div/>', {style: "height:auto;margin:15px 5px 5px auto;width:fit-content;"}).appendTo(row)

                            if (arg.schema.type == 'string' || arg.schema.type == 'number' || arg.schema.type == 'integer') {
                                row2.text(arg.name + ' : ')
                                var valueField;
                                if (arg.schema.enum) {
                                    valueField = $("<select/>", {style: "width:auto;margin-right:5px;"}).appendTo(row2);
                                    arg.schema.enum.forEach(function (value) {
                                        valueField.append($("<option></option>").val(value).text(value))
                                    })
                                } else {
                                    var holder = arg.schema.title || arg.name
                                    if (arg.schema.hasOwnProperty('minimum') || arg.schema.hasOwnProperty('maximum')) {
                                        holder += '('
                                        holder += arg.schema.hasOwnProperty('minimum') ? arg.schema.minimum : ' '
                                        holder += '~'
                                        holder += arg.schema.hasOwnProperty('maximum') ? arg.schema.maximum : ' '
                                        holder += ')'
                                    }

                                    valueField = $("<input/>", {style: "width:auto;margin-right:5px;", placeholder: holder}).appendTo(row2)

                                    var valueType = arg.schema.type
                                    if (valueType == 'integer' || valueType == 'number') {
                                        valueField.typedInput({default: "num", types: ["num"]})
                                    } else {
                                        valueField.typedInput({default: "str", types: ["str"]})
                                    }
                                    valueField.typedInput('width','200px')
                                }
                                valueField.attr('argName', arg.name)
                                valueField.attr('argType', arg.schema.type)
                                valueField.addClass('argValue')
                            } else if (arg.schema.title == 'COLOR_MAP') {
                                row2.text('color : ')
                                var colorField = $("<input/>", {
                                    argName: "color",
                                    argType: "object",
                                    propId: 'hex',
                                    propType: 'string',
                                    class: 'argValue',
                                    type: 'color',
                                    value: "#3366ff",
                                    style: "width:200px;margin-right:5px;"
                                }).appendTo(row2)
                            } else if (arg.schema.type == 'object') {
                                if (arg.schema.properties) {
                                    Object.entries(arg.schema.properties).forEach(function ([propertyId, property]) {
                                        row2.text(propertyId + ' : ')
                                        valueField = $("<input/>", {style: "width:auto;margin-right:5px;", placeholder: holder}).appendTo(row2)
                                        var valueType = property.type

                                        if (valueType == 'integer' || valueType == 'number') {
                                            valueField.typedInput({default: "num", types: ["num"]})
                                        } else {
                                            valueField.typedInput({default: "str", types: ["str"]})
                                        }
                                        valueField.attr('argName', arg.name)
                                        valueField.attr('argType', arg.schema.type)
                                        valueField.attr('propId', propertyId)
                                        valueField.attr('propType', property.type)
                                        valueField.addClass('argValue')
                                    })
                                }
                            }
                        })
                    }

                    if (data && data.args) {
                        data.args.forEach(function (arg) {
                            var valueField
                            if(arg.hasOwnProperty('propId')){
                                valueField = container.find('.argValue[argName='+arg.name+'][propId='+arg.propId+']')
                            }else{
                                valueField = container.find('.argValue[argName=' + arg.name + ']')
                            }
                            if (valueField.hasClass('red-ui-typedInput')) {
                                valueField.typedInput('value', arg.value)
                            } else {
                                valueField.val(arg.value)
                            }
                        })
                    }

                    if ($("#cmd-list-container").editableList('items').length > 1) {
                        $("#cmd-list-container").find(".outputSpan").remove();
                    }

                },
                resizeItem: function (container) {
                },
                removeItem: function (opt) {
                },
                sortItems: function (rules) {
                },
                sortable: false,
                removable: false
            });

            $("#attr-list-container").css('min-height', '150px').css('min-width', '150px').editableList({
                addItem: function (container, idx, data) {
                    var capabilityId = $("#node-input-capabilityId option:selected").val()
                    var attributeId = $("#node-input-attributeId option:selected").val()
                    var attribute = profiles.getAttributeSchema(capabilityId, attributeId)

                    var row = $('<div/>', {style: "height: auto;"}).appendTo(container);

                    var attributeIdField = $('<input/>', {
                        class: "attrId ruleField",
                        capaId: capabilityId,
                        style: "width:auto; margin-right:5px;max-width:35%",
                        type: "text",
                        readonly: "true"
                    }).appendTo(row).val(attributeId)
                    var operatorField = $('<select/>', {class: "attrOperator ruleField", style: "width:auto; margin-right: 5px; text-align: center;"}).appendTo(row)
                    if(attribute.properties.value.title=='Iso8601Date'){
                        attribute.properties.value.type='Iso8601Date'
                    }
                    if (operator[attribute.properties.value.type]) {
                        operator[attribute.properties.value.type].forEach(function (op) {
                            operatorField.append($("<option></option>").val(op.v).text(op.t))
                        })
                    }
                    //attribute properties.value
                    var valueField;
                    if (attribute.properties.value.type == 'array') {
                        valueField = $("<select/>", {style: "width:40%;margin-right:5px;"}).appendTo(row);
                        attribute.properties.value.items.enum.forEach(function (value) {
                            valueField.append($("<option></option>").val(value).text(value))
                        })
                    } else if (attribute.properties.value.enum) {
                        valueField = $("<select/>", {style: "width:40%;margin-right:5px;"}).appendTo(row);

                        attribute.properties.value.enum.forEach(function (value) {
                            valueField.append($("<option></option>").val(value).text(value))
                        })
                    } else {
                        var holder = attribute.properties.value.title || attributeId
                        if (attribute.properties.value.hasOwnProperty('minimum') || attribute.properties.value.hasOwnProperty('maximum')) {
                            holder += '('
                            holder += attribute.properties.value.hasOwnProperty('minimum') ? attribute.properties.value.minimum : ' '
                            holder += '~'
                            holder += attribute.properties.value.hasOwnProperty('maximum') ? attribute.properties.value.maximum : ' '
                            holder += ')'
                        }

                        valueField = $("<input/>", {style: "margin-right:5px;", placeholder: holder}).appendTo(row)

                        var valueType = attribute.properties.value.type
                        if (valueType == 'integer' || valueType == 'number') {
                            valueField.typedInput({default: "num", types: ["num"]})
                        } else {
                            valueField.typedInput({default: "str", types: ["str"]})
                        }
                        if(valueType == 'Iso8601Date'){
                            valueField.typedInput('value',new Date().toISOString().substr(0,19)+'Z')
                        }
                        valueField.typedInput('width','40%')
                    }
                    valueField.attr('valueType', attribute.properties.value.type)
                    valueField.addClass('attrValue ruleField')

                    //'unit' always has string enum
                    var unitField
                    if (attribute.properties.unit && attribute.properties.unit.enum) {
                        unitField = $("<select/>", {class: 'attrUnit ruleField', style: "width:auto;margin-right:5px;"}).appendTo(row);
                        attribute.properties.unit.enum.forEach(function (value) {
                            unitField.append($('<option>').val(value).text(value))
                        })
                        if (attribute.properties.unit.default) {
                            unitField.val(attribute.properties.unit.default)
                        }
                    }

                    if(container.find('.ruleField').length>3){
                        container.find('.attrId').css('width','20%')
                    }
                    // var portSpan = $('<span/>', {style: "float: right;margin-top: 6px;"}).appendTo(row);
                    // portSpan.append(' &#8594; <span class="sensor-attr-output-index">' + (idx + 1) + '</span> ');
                    if (data) {
                        data.operator && operatorField.val(data.operator)
                        if (data.value) {
                            if (valueField.prop('tagName') == 'INPUT') {
                                valueField.typedInput('value', data.value)
                            } else {
                                valueField.val(data.value)
                            }
                        }
                        data.value && valueField.find('.attrValue').val(data.value)
                        data.unit && unitField && unitField.val(data.unit)
                    }
                },
                resizeItem: function (container) {

                },
                removeItem: function (opt) {
                },
                sortItems: function (rules) {
                },
                sortable: true,
                removable: true
            });
        },
        //type값에 따른 페이지 초기화 함수
        initAttributeContainer: function (rules) {
            this.form.container.editableList('empty')

            if (rules && rules.length) {
                for (var i = 0; i < this.node.rules.length; i++) {
                    var data = this.node.rules[i];
                    if (data.isInit) break;
                    if(data.capaId == this.form.capabilityId.val() && data.attrId == this.form.attributeId.val()){
                        this.form.container.editableList('addItem', data);
                    }
                }
            }

            if (this.form.attributeId.val() && this.form.container.editableList('items').length == 0) {
                this.form.container.editableList('addItem')
            }
        }
    };

    //convert RGB value to HSL value
    function rgbToHsl(hex) {
        if (/^#[0-9a-f]{6}$/g.test(hex) == false) {
            return {hue: 0, saturation: 0, lightness: 0}
        }
        var r = parseInt(hex.substring(1, 3), 16) / 255
        var g = parseInt(hex.substring(3, 5), 16) / 255
        var b = parseInt(hex.substring(5, 7), 16) / 255
        var max = Math.max(r, g, b)
        var min = Math.min(r, g, b)
        var hue
        if (max == min) {
            hue = 0
        } else if (r == max) {
            hue = 0 + (g - b) / (max - min)
        } else if (g == max) {
            hue = 2 + (b - r) / (max - min)
        } else {
            hue = 4 + (r - g) / (max - min)
        }
        hue *= 60

        var lightness = (max + min) / 2

        var saturation
        if (lightness == 0 || lightness == 1) {
            saturation = 0
        } else {
            a1 = 2 * (max - lightness)
            a2 = 1 - Math.abs(2 * lightness - 1)
            saturation = a1 / a2
        }

        hue = Math.round(hue / 360 * 100)
        saturation = Math.round(saturation * 100)
        lightness = Math.round(lightness * 100)
        return {hex: hex, hue: hue, saturation: saturation, lightness: lightness}
    }

    DeviceNode.prototype = {
        color: "rgb(170, 75, 205)",
        category: "Samsung AutomationStudio",
        //defaults
        inputs: 1,
        outputs: 1,
        paletteLabel: "Device Control",
        icon: "Device.png",
        label: function () {
            return this.name || this.type;
        },
        labelStyle: function () {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function () {
            var NODE = this;

            var target = (NODE.type == ST_COMMAND_DEVICE) ? "commands" : "attributes"
            NODE.target = target

            var formObj = {
                deviceNodeId: $("#node-input-deviceNodeId"),
                capabilityId: $("#node-input-capabilityId"),
                attributeId: $("#node-input-attributeId"),
                container: ((NODE.type == ST_COMMAND_DEVICE) ? $("#cmd-list-container") : $("#attr-list-container")),
            }

            var eventHandler = new DeviceNodeEventHandler(formObj, NODE)
        },
        /*편집 대화 상자 완료처리시 호출*/
        oneditsave: function () {
            var NODE = this;
            NODE.deviceId = $('#node-input-deviceNodeId').find('option:selected').data('device').deviceId || ''

            NODE.rules = []

            $("#cmd-list-container").editableList('items').each(function (idx, item) {
                var rule = {};
                rule.capaId = item.find('.capaId').text()
                rule.attrId = item.find(".attrId").text()
                rule.args = [];
                item.find(".argValue").each(function (idx, _arg) {
                    var arg = {}

                    arg.name = $(_arg).attr('argName')
                    arg.type = $(_arg).attr('argType')
                    arg.value = $(_arg).val()
                    if ($(_arg).attr('propId')) {
                        arg.propId = $(_arg).attr('propId')
                    }
                    if ($(_arg).attr('propType')) {
                        arg.propType = $(_arg).attr('propType')
                    }
                    rule.args.push(arg)

                    if (arg.name == 'color') {
                        var hsl = rgbToHsl(arg.value)
                        rule.args.push({name: 'color', type: 'object', propId: 'hue', propType: 'number', value: hsl.hue})
                        rule.args.push({name: 'color', type: 'object', propId: 'saturation', propType: 'number', value: hsl.saturation})
                    }
                })
                NODE.rules.push(rule)
            })

            $("#attr-list-container").editableList('items').each(function (idx, item) {
                var rule = {}
                rule.capaId = item.find(".attrId").attr('capaId')
                rule.attrId = item.find(".attrId").val()
                rule.operator = item.find(".attrOperator").val()
                rule.value = item.find(".attrValue").val()
                rule.valueType = item.find(".attrValue").attr('valueType')
                rule.unit = item.find(".attrUnit").val()

                NODE.rules.push(rule)
            })

            this.outputs = NODE.rules.length || 1
        },
        //editor height 변화에 따라 attr-container의 height를 조정한다.
        oneditresize: function (size) {
            var rows;
            var resizeContainer;
            var editorRow;

            if (this.type == ST_COMMAND_DEVICE) {
                rows = $("#dialog-form>div:not('[class$=container-row]')");
                editorRow = $("#dialog-form>div.actuator-container-row");
                resizeContainer = $("#cmd-list-container");
            } else {
                //event, sensor
                rows = $("#dialog-form>div:not('[class$=container-row]')");
                editorRow = $("#dialog-form>div.sensor-container-row");
                resizeContainer = $("#attr-list-container");
            }

            var height = size.height;
            for (var i = 0; i < rows.size(); i++) {
                height -= $(rows[i]).outerHeight(true);
            }

            height -= (parseInt(editorRow.css("marginTop")) + parseInt(editorRow.css("marginBottom")))
            resizeContainer.editableList('height', height - 100)
        }
    }

    function DeviceNode(type) {

        if (type === 'event') {
            this.paletteLabel = "Event";
            this.color = "rgb(113,179,145)";
            this.icon = "st-event.png";
        } else if (type === 'status') {
            this.paletteLabel = "Status";
            this.color = "rgb(119,197,191)";
            this.icon = "st-status.png";
        } else {
            this.paletteLabel = "Command";
            this.color = "rgb(255,198,109)";
            this.icon = "st-command.png";
        }

        var defaultsConfig = {//노드 의 편집 가능한 속성과 deploy시 json 형태로 저장될 데이터구조명시
            name: {required: true},
            deviceNodeId: {
                value: "", required: true,
                validate: function (val) {
                    var isValidDevice = false;
                    RED.nodes.eachNode(function (node) {
                        if (node.id == val) {
                            isValidDevice = true
                        }
                    })
                    return !!val && isValidDevice
                }
            },
            deviceId: {value: ""},
            componentID: {value: ""},
            capabilityId: {value: "", required: true},
            attributeId: {value: "", required: true},
            rules: {value: [{isInit: true}]},
            outputs: {value: 1}
        }
        this.defaults = defaultsConfig
    }

    RED.nodes.registerType(ST_EVENT_DEVICE, new DeviceNode("event"));
    RED.nodes.registerType(ST_STATUS_DEVICE, new DeviceNode("status"));
    RED.nodes.registerType(ST_COMMAND_DEVICE, new DeviceNode("command"));

    //@ sourceURL=device.node.js
</script>
<!-- Node Script End-->
